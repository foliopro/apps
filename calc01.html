<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Calculadora Laboral (Responsive)</title>
  <style>
    :root {
      --bg:#0f1115; --panel:#171a21; --key:#232736; --key-acc:#2e3450;
      --primary:#4183ff; --danger:#ff3b3b; --text:#e9eef8; --muted:#a7b1c2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:16px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-tap-highlight-color: transparent;
    }

    /* ----- Contenedor principal responsive ----- */
    .app{
      width:100%;
      max-width:480px;
      margin:0 auto;
      padding:clamp(10px, 3vw, 16px);
      background:var(--panel);
      border-radius:16px 16px 0 0;
      box-shadow:0 -4px 30px rgba(0,0,0,.35);
      min-height:100dvh; /* ocupa alto disponible en móviles */
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* ----- Pantalla ----- */
    .screen{
      background:#0b0d12;border-radius:12px;
      padding:clamp(10px, 3.5vw, 16px);
      min-height:68px;
      display:flex;flex-direction:column;justify-content:center;
    }
    .expr{font-size:clamp(18px, 5.2vw, 24px);word-wrap:anywhere}
    .result{font-size:clamp(12px, 3.4vw, 14px);color:var(--muted);min-height:18px}

    /* ----- Teclado ----- */
    .keypad{
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:clamp(6px, 2.4vw, 10px);
    }
    .key{
      background:var(--key);border:0;color:var(--text);
      padding:clamp(10px, 3.4vw, 14px);
      border-radius:12px;font-weight:600;cursor:pointer;
      font-size:clamp(14px, 4vw, 18px);
      touch-action:manipulation;
    }
    .key:hover{filter:brightness(1.08)}
    .key:active{transform:translateY(1px)}
    .op{background:var(--key-acc)}
    .primary{background:var(--primary);color:#fff}
    .danger{background:var(--danger)}
    .wide{grid-column:span 2}
    .small{padding:8px 10px;border-radius:10px;font-size:clamp(12px,3.5vw,14px)}

    /* ----- Barra de módulos ----- */
    .special-bar{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:2px
    }
    .special-bar label{font-size:clamp(12px,3.5vw,14px);color:var(--muted)}
    select{
      flex:1;min-width:160px;width:100%;
      background:var(--key);color:var(--text);border:0;border-radius:10px;
      padding:10px;font-size:clamp(14px, 3.8vw, 16px);
    }

    /* ----- Modal responsive ----- */
    dialog{
      width:min(92vw, 480px);
      border:0;border-radius:14px;background:var(--panel);color:var(--text);
      padding:14px;
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .fields{display:grid;gap:10px;margin:12px 0}
    .field-row{
      display:grid;
      grid-template-columns:1fr 1fr; /* escritorio: etiqueta a la izquierda, input a la derecha */
      gap:10px;align-items:center;
    }
    .field-row label{
      font-size:14px;color:var(--muted);
      overflow-wrap:anywhere; /* evita que se corte el texto */
      white-space:normal;
    }
    .field-row input{
      background:#0b0d12;border:1px solid #1f2433;color:var(--text);
      padding:12px;border-radius:10px;width:100%;
      font-size:16px;
    }
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}

    /* ----- Ajustes para pantallas angostas ----- */
    @media (max-width: 420px){
      .app{border-radius:0;min-height:100dvh}
      .field-row{grid-template-columns:1fr} /* etiqueta arriba, input abajo */
      .field-row label{margin-bottom:2px}
      .keypad{gap:8px}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Pantalla -->
    <div class="screen" aria-live="polite">
      <div id="expr" class="expr">0</div>
      <div id="result" class="result"> </div>
    </div>

    <!-- Teclado principal -->
    <div class="keypad" role="group" aria-label="Teclado calculadora">
      <button data-act="ac" class="key danger">AC</button>
      <button data-act="del" class="key">DEL</button>
      <button data-val="(" class="key">(</button>
      <button data-val=")" class="key">)</button>

      <button data-val="7" class="key">7</button>
      <button data-val="8" class="key">8</button>
      <button data-val="9" class="key">9</button>
      <button data-op="÷" class="key op">÷</button>

      <button data-val="4" class="key">4</button>
      <button data-val="5" class="key">5</button>
      <button data-val="6" class="key">6</button>
      <button data-op="×" class="key op">×</button>

      <button data-val="1" class="key">1</button>
      <button data-val="2" class="key">2</button>
      <button data-val="3" class="key">3</button>
      <button data-op="−" class="key op">−</button>

      <button data-val="0" class="key wide">0</button>
      <button data-val="." class="key">.</button>
      <button data-op="+" class="key op">+</button>
      <button data-act="eq" class="key primary">=</button>
    </div>

    <!-- Barra de módulos laborales -->
    <div class="special-bar">
      <label for="specialSelect">Módulos laborales:</label>
      <select id="specialSelect" aria-label="Selecciona un módulo especial"></select>
      <button id="runSpecial" class="key primary small">Calcular</button>
    </div>
  </div>

  <!-- Modal para inputs -->
  <dialog id="specialDialog">
    <form method="dialog" id="specialForm">
      <h3 id="specialTitle" style="margin:0;">Cálculo especial</h3>
      <div id="specialFields" class="fields"></div>
      <menu class="modal-actions">
        <button value="cancel" class="key">Cancelar</button>
        <button id="specialSubmit" value="ok" class="key primary">OK</button>
      </menu>
    </form>
  </dialog>

  <script>
    // ====== Evaluación segura para la calculadora básica ======
    function safeEval(expr) {
      const normalized = expr.replace(/÷/g, "/").replace(/×/g, "*").replace(/−/g, "-");
      const allowed = /^[0-9+\-*/().\s]+$/;
      if (!allowed.test(normalized)) return "Error";
      try {
        const fn = new Function(`return (${normalized})`);
        const r = fn();
        return (typeof r === "number" && isFinite(r)) ? r : "Error";
      } catch { return "Error"; }
    }

    // ====== Estado UI ======
    const exprEl = document.getElementById("expr");
    const resultEl = document.getElementById("result");
    let expr = "0";
    function render(){ exprEl.textContent = expr || "0"; }
    function appendVal(v){ if (expr==="0" && /[0-9.]/.test(v)) expr=v; else expr+=v; render(); }
    function appendOp(op){ appendVal(op); }
    function doAC(){ expr="0"; resultEl.textContent=""; render(); }
    function doDEL(){ expr = expr.length>1 ? expr.slice(0,-1) : "0"; render(); }
    function doEQ(){ const res = safeEval(expr); resultEl.textContent = (res==="Error")?"Expresión inválida":`= ${res}`; }

    document.querySelectorAll("[data-val]").forEach(b=>b.addEventListener("click",()=>appendVal(b.dataset.val)));
    document.querySelectorAll("[data-op]").forEach(b=>b.addEventListener("click",()=>appendOp(b.dataset.op)));
    document.querySelector("[data-act='ac']").addEventListener("click",doAC);
    document.querySelector("[data-act='del']").addEventListener("click",doDEL);
    document.querySelector("[data-act='eq']").addEventListener("click",doEQ);

    // ====== Sistema modular de cálculos laborales ======
    const specialRegistry = new Map();
    function registerSpecial({ id, label, fields, compute }) {
      specialRegistry.set(id, { id, label, fields, compute });
    }

    const specialSelect = document.getElementById("specialSelect");
    const runSpecialBtn = document.getElementById("runSpecial");
    const dialogEl = document.getElementById("specialDialog");
    const fieldsEl = document.getElementById("specialFields");
    const titleEl = document.getElementById("specialTitle");
    const submitBtn = document.getElementById("specialSubmit");

    function refreshSpecialSelect(){
      specialSelect.innerHTML = "";
      for (const mod of specialRegistry.values()){
        const opt = document.createElement("option");
        opt.value = mod.id; opt.textContent = mod.label;
        specialSelect.appendChild(opt);
      }
    }

    runSpecialBtn.addEventListener("click", ()=>{
      const mod = specialRegistry.get(specialSelect.value);
      if (!mod) return;
      titleEl.textContent = mod.label;
      fieldsEl.innerHTML = "";
      mod.fields.forEach(f=>{
        const row = document.createElement("div");
        row.className = "field-row";
        const lab = document.createElement("label");
        lab.textContent = f.label;
        lab.setAttribute("for", f.name);
        const inp = document.createElement("input");
        inp.type = "number"; inp.step = "any"; inp.id = f.name; inp.placeholder = f.placeholder || "0";
        row.appendChild(lab); row.appendChild(inp);
        fieldsEl.appendChild(row);
      });
      dialogEl.showModal();
    });

    submitBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      const mod = specialRegistry.get(specialSelect.value);
      if (!mod) return;
      const vars = {};
      mod.fields.forEach(f=>{
        const v = Number((document.getElementById(f.name).value || "0").replace(",", "."));
        vars[f.name] = isNaN(v) ? 0 : v;
      });
      const out = mod.compute(vars) || {};
      const value = typeof out.result === "number" ? Number(out.result.toFixed(2)) : "Error";
      expr = `${mod.label}`;
      resultEl.textContent = (value==="Error") ? "Error en cálculo" : `= ${value}`;
      render();
      dialogEl.close();
    });

    // ====== Módulo 1: Cesantías ======
    registerSpecial({
      id: "cesantias",
      label: "Cesantías",
      fields: [
        { name: "salario", label: "Salario", placeholder: "ej. 2000000" },
        { name: "aux_transporte", label: "Aux. transporte", placeholder: "ej. 162000" },
        { name: "dias_lab", label: "Días laborados", placeholder: "ej. 360" },
      ],
      compute: ({ salario, aux_transporte, dias_lab }) => {
        const base = (salario + aux_transporte);
        const result = (base / 360) * dias_lab;
        return { result };
      }
    });

    // ====== Módulo 2: Prima de Servicios ======
    registerSpecial({
      id: "prima",
      label: "Prima de Servicios",
      fields: [
        { name: "salario", label: "Salario", placeholder: "ej. 2000000" },
        { name: "dias_lab", label: "Días laborados", placeholder: "ej. 180" },
      ],
      compute: ({ salario, dias_lab }) => {
        const result = (salario / 360) * dias_lab; 
        return { result };
      }
    });

    // ====== Módulo 3: Vacaciones ======
    registerSpecial({
      id: "vacaciones",
      label: "Vacaciones",
      fields: [
        { name: "salario", label: "Salario", placeholder: "ej. 2000000" },
        { name: "dias_lab", label: "Días laborados", placeholder: "ej. 360" },
      ],
      compute: ({ salario, dias_lab }) => {
        const result = (salario / 720) * dias_lab; 
        return { result };
      }
    });

    refreshSpecialSelect();
    render();
  </script>
</body>
</html>


